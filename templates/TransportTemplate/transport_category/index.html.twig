{% extends 'BackOffice/base.html.twig' %}

{% block title %}Gestion Catégories | EcoTrip Admin{% endblock %}
{% block page_title %}Gestion des Catégories de Transport{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
.user-mgmt { font-family: 'Plus Jakarta Sans', sans-serif; }
.user-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-box { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.04); }
.stat-box h4 { font-size: 1.75rem; font-weight: 800; margin: 0 0 4px 0; color: #0f172a; }
.stat-box span { font-size: 0.85rem; color: #64748b; }
.toolbar { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 24px; }
.search-wrap { flex: 1; min-width: 220px; position: relative; }
.search-wrap input { width: 100%; padding: 12px 16px 12px 44px; border: 1.5px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; }
.search-wrap i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
.btn-add { padding: 12px 24px; background: linear-gradient(135deg, #2563eb, #3b82f6); color: white; border: none; border-radius: 12px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
.btn-add:hover { color: white; opacity: 0.95; }
.table-card { background: white; border-radius: 20px; box-shadow: 0 4px 24px rgba(0,0,0,0.06); overflow: hidden; border: 1px solid rgba(0,0,0,0.04); }
.table-card table { width: 100%; border-collapse: collapse; }
.table-card th { padding: 16px 20px; text-align: left; font-weight: 600; font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.table-card td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; }
.table-card tr:hover td { background: #fafbfc; }
.user-avatar-placeholder { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #2563eb; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem; vertical-align: middle; margin-right: 10px; }
.btn-action { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 8px; color: #64748b; transition: all 0.2s; border: none; background: none; }
.btn-action:hover { color: white; }
.btn-action.edit:hover { background: #2563eb; }
.btn-action.view:hover { background: #16a34a; }
.btn-action.delete:hover { background: #ef4444; }
.chart-card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 24px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.04); margin-bottom: 24px; }
.chart-card h4 { font-size: 1rem; font-weight: 600; margin: 0 0 16px 0; color: #0f172a; }
.chart-wrap { height: 250px; position: relative; }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid user-mgmt">
    {% for flash in app.flashes('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ flash }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    <div class="user-stats">
        <div class="stat-box"><h4>{{ stats.total }}</h4><span>Total Catégories</span></div>
        <div class="stat-box"><h4>{{ stats.top|length }}</h4><span>Catégories Actives</span></div>
    </div>

    <div class="chart-card">
        <h4>Utilisation des Catégories (Top 5)</h4>
        <div class="chart-wrap"><canvas id="chartTopCategories"></canvas></div>
    </div>

    <div class="toolbar">
        <div class="search-wrap">
            <i class="fa fa-search"></i>
            <input type="text" id="searchInput" placeholder="Rechercher une catégorie..." value="{{ q }}">
        </div>
        <a href="{{ path('app_transport_category_new') }}" class="btn-add"><i class="fa fa-plus"></i> Nouvelle Catégorie</a>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Nombre de Transports</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="categoryTableBody">
                {% include 'TransportTemplate/transport_category/_category_table.html.twig' with {categories: categories} %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('chartTopCategories');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ stats.chartLabels|json_encode|raw }},
                datasets: [{
                    label: 'Nombre de transports',
                    data: {{ stats.chartData|json_encode|raw }},
                    backgroundColor: '#3b82f6',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }

    let debounce;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(debounce);
        debounce = setTimeout(() => {
            const q = this.value;
            fetch('{{ path('app_transport_category_ajax') }}?q=' + encodeURIComponent(q))
                .then(r => r.text())
                .then(html => { document.getElementById('categoryTableBody').innerHTML = html; });
        }, 300);
    });
});
</script>
{% endblock %}
