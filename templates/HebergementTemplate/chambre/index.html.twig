{% extends 'BackOffice/base.html.twig' %}

{% block title %}Gestion des Chambres | EcoTrip Admin{% endblock %}
{% block page_title %}Gestion des Chambres{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
.room-mgmt { font-family: 'Plus Jakarta Sans', sans-serif; }

.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    margin-bottom: 24px;
}
.search-wrap {
    flex: 1;
    min-width: 250px;
    position: relative;
}
.search-wrap input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    border: 1.5px solid #e2e8f0;
    border-radius: 12px;
    font-size: 0.95rem;
}
.search-wrap i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

.btn-add {
    padding: 12px 24px;
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-add:hover { color: white; opacity: 0.95; transform: translateY(-1px); transition: all 0.2s; }

.table-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.04);
}
.table-card table { width: 100%; border-collapse: collapse; }
.table-card th {
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}
.table-card td {
    padding: 16px 20px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
}
.table-card tr:hover td { background: #fafbfc; }

.badge-verified { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
.badge-verified.yes { background: #dcfce7; color: #166534; }
.badge-verified.no { background: #fee2e2; color: #991b1b; }

.btn-action {
    display: inline-flex; align-items: center; justify-content: center;
    width: 36px; height: 36px; border-radius: 10px;
    color: #64748b; text-decoration: none;
    transition: all 0.2s;
    background: #f8fafc;
}
.btn-action:hover { color: white; transform: translateY(-2px); }
.btn-action.edit:hover { background: #2563eb; }
.btn-action.view:hover { background: #10b981; }
.btn-action.delete:hover { background: #ef4444; }
.btn-action.delete { border: none; cursor: pointer; }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid room-mgmt py-4">
    <div class="toolbar">
        <div class="search-wrap">
            <i class="bi bi-search"></i>
            <input type="text" id="searchInput" name="q" value="{{ filters.q|default('') }}" placeholder="Rechercher une chambre (numéro, type, hôtel)...">
        </div>
        <a href="{{ path('app_chambre_new') }}" class="btn-add">
            <i class="bi bi-plus-lg"></i> Ajouter une Chambre
        </a>
        <div class="btn-group ms-auto">
            <button class="btn btn-outline-primary active" id="viewTableBtn"><i class="bi bi-table"></i> Liste</button>
            <button class="btn btn-outline-primary" id="viewCalendarBtn"><i class="bi bi-calendar3"></i> Calendrier</button>
        </div>
    </div>

    <div class="table-card mb-4" id="tableContainer">
        <table>
            <thead>
                <tr>
                    <th>Chambre</th>
                    <th>Hébergement</th>
                    <th>Capacité</th>
                    <th>Prix / Nuit</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="chambreTableBody">
                {{ include('HebergementTemplate/chambre/_table.html.twig') }}
            </tbody>
        </table>
    </div>

    <div class="table-card p-4" id="calendarContainer" style="display: none;">
        <div id="calendar"></div>
    </div>
</div>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const tableBody = document.getElementById('chambreTableBody');
        let timeout = null;

        function fetchResults() {
            const q = searchInput.value;
            const params = new URLSearchParams({ q: q, ajax: '1' });

            tableBody.style.opacity = '0.6';

            fetch('{{ path('app_chambre_index') }}?' + params.toString(), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                tableBody.innerHTML = html;
                tableBody.style.opacity = '1';
            })
            .catch(error => {
                console.error('Error:', error);
                tableBody.style.opacity = '1';
            });
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(fetchResults, 300);
        });

        // Calendar View Logic
        const viewTableBtn = document.getElementById('viewTableBtn');
        const viewCalendarBtn = document.getElementById('viewCalendarBtn');
        const tableContainer = document.getElementById('tableContainer');
        const calendarContainer = document.getElementById('calendarContainer');
        let calendar = null;

        function initCalendar() {
            if (calendar) return;
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                locale: 'fr',
                themeSystem: 'bootstrap5',
                events: [
                    {% for chambre in chambres %}
                    {
                        title: 'Chambre {{ chambre.numero }} ({{ chambre.hebergement.nom|e('js') }})',
                        start: '{{ "now"|date("Y-m-d") }}', // Example, would need actual booking dates
                        color: '{{ chambre.disponible ? "#10b981" : "#ef4444" }}',
                        extendedProps: {
                            price: '{{ chambre.prixParNuit }}',
                            type: '{{ chambre.type|e('js') }}'
                        }
                    },
                    {% endfor %}
                ],
                eventClick: function(info) {
                    alert('Chambre: ' + info.event.title + '\nPrix: ' + info.event.extendedProps.price + ' DT');
                }
            });
            calendar.render();
        }

        viewTableBtn.addEventListener('click', () => {
            tableContainer.style.display = 'block';
            calendarContainer.style.display = 'none';
            viewTableBtn.classList.add('active');
            viewCalendarBtn.classList.remove('active');
        });

        viewCalendarBtn.addEventListener('click', () => {
            tableContainer.style.display = 'none';
            calendarContainer.style.display = 'block';
            viewTableBtn.classList.remove('active');
            viewCalendarBtn.classList.add('active');
            setTimeout(() => {
                initCalendar();
                calendar.updateSize();
            }, 50);
        });
        // Google Calendar Prompt Logic
        const calendarMessages = {{ app.flashes('google_calendar_prompt')|json_encode|raw }};
        if (calendarMessages.length > 0) {
            const eventData = JSON.parse(calendarMessages[0]);
            
            // Format dates for Google Calendar (YYYYMMDDTHHMMSSZ)
            const now = new Date();
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            const formatGCalDate = (date) => date.toISOString().replace(/-|:|\.\d\d\d/g, "");

            Swal.fire({
                title: 'Chambre ajoutée !',
                text: "Voulez-vous ajouter une disponibilité dans Google Calendar ?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Oui, ajouter !',
                cancelButtonText: 'Non, merci'
            }).then((result) => {
                if (result.isConfirmed) {
                    const title = encodeURIComponent(eventData.title);
                    const details = encodeURIComponent(eventData.details);
                    const location = encodeURIComponent(eventData.location);
                    const dates = `${formatGCalDate(now)}/${formatGCalDate(oneHourLater)}`;
                    
                    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&location=${location}&dates=${dates}`;
                    window.open(url, '_blank');
                }
            });
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}
