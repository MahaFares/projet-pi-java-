{# ================================================
   WIDGET CHATBOT AI TRAVEL AGENT - ECOTRIP
   Version: 1.0 - Sans erreurs de syntaxe
   ================================================ #}

<style>
/* ========================================
   STYLES DU CHATBOT
   ======================================== */

#chatbot-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Bouton flottant */
#chatbot-toggle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

#chatbot-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
}

#chatbot-toggle.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
    }
    50% { 
        transform: scale(1.05); 
    }
}

/* Fen√™tre de chat */
#chatbot-window {
    display: none;
    width: 380px;
    height: 600px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    position: absolute;
    bottom: 80px;
    right: 0;
    flex-direction: column;
    overflow: hidden;
}

#chatbot-window.open {
    display: flex;
    animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Header */
#chatbot-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

#chatbot-header-content h3 {
    margin: 0 0 4px 0;
    font-size: 18px;
    font-weight: 600;
}

#chatbot-header-content small {
    opacity: 0.9;
    font-size: 13px;
}

#chatbot-provider-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    margin-top: 4px;
    display: inline-block;
}

#chatbot-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
}

#chatbot-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

/* Zone des messages */
#chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: linear-gradient(to bottom, #f7f9fc 0%, #e9ecef 100%);
}

.message {
    margin-bottom: 16px;
    display: flex;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translateY(10px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.message.user {
    justify-content: flex-end;
}

.message.bot {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    line-height: 1.5;
    font-size: 14px;
}

.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 4px;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.message.bot .message-bubble {
    background: white;
    color: #2d3748;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
}

/* Indicateur de saisie */
.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 12px 16px;
    background: white;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    width: fit-content;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) { 
    animation-delay: 0.2s; 
}

.typing-dot:nth-child(3) { 
    animation-delay: 0.4s; 
}

@keyframes typing {
    0%, 60%, 100% { 
        opacity: 0.3; 
        transform: translateY(0); 
    }
    30% { 
        opacity: 1; 
        transform: translateY(-8px); 
    }
}

/* Zone d'input */
#chatbot-input-container {
    padding: 16px;
    background: white;
    border-top: 1px solid #e2e8f0;
}

#chatbot-input-form {
    display: flex;
    gap: 10px;
}

#chatbot-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 24px;
    font-size: 14px;
    outline: none;
    transition: all 0.2s;
    font-family: inherit;
}

#chatbot-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

#chatbot-send {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

#chatbot-send:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

#chatbot-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Scrollbar personnalis√©e */
#chatbot-messages::-webkit-scrollbar {
    width: 6px;
}

#chatbot-messages::-webkit-scrollbar-track {
    background: transparent;
}

#chatbot-messages::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}

#chatbot-messages::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

/* Responsive */
@media (max-width: 480px) {
    #chatbot-window {
        width: calc(100vw - 40px);
        height: calc(100vh - 100px);
        right: 20px;
        bottom: 80px;
    }
}
</style>

<!-- ======================================== 
     HTML DU CHATBOT 
     ======================================== -->

<div id="chatbot-container">
    
    <!-- Bouton pour ouvrir le chat -->
    <button type="button" id="chatbot-toggle" class="pulse" aria-label="Ouvrir le chatbot">
        üí¨
    </button>

    <!-- Fen√™tre de chat -->
    <div id="chatbot-window">
        
        <!-- Header -->
        <div id="chatbot-header">
            <div id="chatbot-header-content">
                <h3>ü§ñ EcoTrip Assistant</h3>
                <small>Votre guide voyage √©co-responsable</small>
                <div id="chatbot-provider-badge">Hugging Face</div>
            </div>
            <button type="button" id="chatbot-close" aria-label="Fermer le chatbot">‚úï</button>
        </div>

        <!-- Messages -->
        <div id="chatbot-messages">
            <div class="message bot">
                <div class="message-bubble">
                    üëã Bonjour ! Je suis votre assistant voyage √©co-responsable.<br><br>
                    Comment puis-je vous aider √† trouver l'h√©bergement id√©al en Tunisie ? üåø
                </div>
            </div>
        </div>

        <!-- Zone d'input -->
        <div id="chatbot-input-container">
            <form id="chatbot-input-form">
                <input 
                    type="text" 
                    id="chatbot-input" 
                    placeholder="Posez votre question..."
                    autocomplete="off"
                    maxlength="500"
                    required
                >
                <button type="submit" id="chatbot-send" aria-label="Envoyer">
                    ‚û§
                </button>
            </form>
        </div>

    </div>
</div>

<!-- ======================================== 
     JAVASCRIPT DU CHATBOT 
     ======================================== -->

<script>
(function() {
    'use strict';

    // Defensive checks: bail out if required elements are missing
    var container = document.getElementById('chatbot-container');
    if (!container) return;

    var toggle = document.getElementById('chatbot-toggle');
    var chatWindow = document.getElementById('chatbot-window');
    var closeBtn = document.getElementById('chatbot-close');
    var messagesDiv = document.getElementById('chatbot-messages');
    var form = document.getElementById('chatbot-input-form');
    var input = document.getElementById('chatbot-input');
    var sendBtn = document.getElementById('chatbot-send');
    var providerBadge = document.getElementById('chatbot-provider-badge');

    var isOpen = false;
    var isTyping = false;

    // URLs des API (hardcod√©es pour √©viter les erreurs Twig)
    var API_MESSAGE_URL = '/api/chatbot/message';
    var API_PROVIDER_URL = '/api/chatbot/provider';

    // Attach only if elements exist
    function init() {
        if (providerBadge) loadProvider();
        attachEventListeners();
    }

    function attachEventListeners() {
        if (toggle) {
            toggle.addEventListener('click', function() {
                isOpen = true;
                toggle.style.display = 'none';
                if (chatWindow) chatWindow.classList.add('open');
                if (input) input.focus();
                scrollToBottom();
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                isOpen = false;
                if (chatWindow) chatWindow.classList.remove('open');
                setTimeout(function() { if (toggle) toggle.style.display = 'flex'; }, 300);
            });
        }

        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!input) return;

                var message = input.value.trim();
                if (!message || isTyping) return;

                addMessage(message, 'user');
                input.value = '';
                if (sendBtn) sendBtn.disabled = true;

                showTypingIndicator();
                isTyping = true;

                try {
                    var resp = await fetch(API_MESSAGE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message })
                    });

                    var data = await resp.json();
                    hideTypingIndicator();

                    if (data && data.success) {
                        addMessage(data.response || 'R√©ponse vide', 'bot');
                        if (data.provider && providerBadge) {
                            providerBadge.textContent = (data.provider === 'openai') ? 'OpenAI GPT-4' : 'Hugging Face';
                        }
                    } else {
                        addMessage((data && data.response) || 'D√©sol√©, une erreur est survenue.', 'bot');
                    }
                } catch (err) {
                    hideTypingIndicator();
                    addMessage('‚ùå Erreur de connexion. V√©rifiez votre connexion internet.', 'bot');
                    console.error(err);
                } finally {
                    isTyping = false;
                    if (sendBtn) sendBtn.disabled = false;
                    if (input) input.focus();
                }
            });
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isOpen) {
                if (closeBtn) closeBtn.click();
            }
        });

        setTimeout(function() { if (toggle) toggle.classList.remove('pulse'); }, 5000);
    }

    function addMessage(text, type) {
        if (!messagesDiv) return;
        var messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + type;

        var bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerHTML = String(text).replace(/\n/g, '<br>');

        messageDiv.appendChild(bubble);
        messagesDiv.appendChild(messageDiv);

        scrollToBottom();
    }

    function showTypingIndicator() {
        if (!messagesDiv) return;
        var indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'message bot';
        indicator.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
        messagesDiv.appendChild(indicator);
        scrollToBottom();
    }

    function hideTypingIndicator() {
        var indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    function scrollToBottom() {
        if (!messagesDiv) return;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function loadProvider() {
        try {
            var resp = await fetch(API_PROVIDER_URL);
            var data = await resp.json();
            if (providerBadge) providerBadge.textContent = (data && data.provider === 'openai') ? 'OpenAI GPT-4' : 'Hugging Face';
        } catch (err) {
            console.error('Erreur chargement provider:', err);
        }
    }

    // Kickoff
    init();

})();
</script>
