{% extends 'BackOffice/base.html.twig' %}

{% block title %}Utilisateurs | EcoTrip Admin{% endblock %}
{% block page_title %}Gestion des Utilisateurs{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
.user-mgmt { font-family: 'Plus Jakarta Sans', sans-serif; }

.user-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-box {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.04);
}
.stat-box h4 { font-size: 1.75rem; font-weight: 800; margin: 0 0 4px 0; color: #0f172a; }
.stat-box span { font-size: 0.85rem; color: #64748b; }

.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    margin-bottom: 24px;
}
.search-wrap {
    flex: 1;
    min-width: 220px;
    position: relative;
}
.search-wrap input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    border: 1.5px solid #e2e8f0;
    border-radius: 12px;
    font-size: 0.95rem;
}
.search-wrap i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
.filter-wrap select {
    padding: 12px 16px;
    border: 1.5px solid #e2e8f0;
    border-radius: 12px;
    font-size: 0.95rem;
    min-width: 140px;
}
.btn-export {
    padding: 12px 20px;
    background: linear-gradient(135deg, #16a34a, #22c55e);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-export:hover { color: white; opacity: 0.95; }
.btn-add {
    padding: 12px 24px;
    background: linear-gradient(135deg, #2563eb, #3b82f6);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-add:hover { color: white; opacity: 0.95; }

.table-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.04);
}
.table-card table { width: 100%; border-collapse: collapse; }
.table-card th {
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}
.table-card td {
    padding: 16px 20px;
    border-bottom: 1px solid #f1f5f9;
}
.table-card tr:hover td { background: #fafbfc; }
.user-avatar-sm { width: 36px; height: 36px; border-radius: 10px; object-fit: cover; vertical-align: middle; margin-right: 10px; }
.user-avatar-placeholder {
    width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    color: #2563eb; font-weight: 700; display: inline-flex; align-items: center; justify-content: center;
    font-size: 0.9rem; vertical-align: middle; margin-right: 10px;
}
.badge-role { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
.badge-role.admin { background: #fef3c7; color: #92400e; }
.badge-role.user { background: #dbeafe; color: #1e40af; }
.badge-verified { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
.badge-verified.yes { background: #dcfce7; color: #166534; }
.badge-verified.no { background: #fee2e2; color: #991b1b; }
.btn-action {
    display: inline-flex; align-items: center; justify-content: center;
    width: 36px; height: 36px; border-radius: 10px;
    color: #64748b; text-decoration: none;
    transition: all 0.2s;
}
.btn-action:hover { color: white; }
.btn-action.edit:hover { background: #2563eb; }
.btn-action.view:hover { background: #16a34a; }
.btn-action.delete:hover { background: #ef4444; }
.btn-action.delete { border: none; background: none; cursor: pointer; font-size: 1rem; }

.charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
@media (max-width: 768px) { .charts-row { grid-template-columns: 1fr; } }
.chart-card {
    background: white;
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.04);
}
.chart-card h4 { font-size: 1rem; font-weight: 600; margin: 0 0 16px 0; color: #0f172a; }
.chart-wrap { height: 220px; position: relative; }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid user-mgmt">
    {% for flash in app.flashes('success') %}
        <div class="alert alert-success" role="alert">{{ flash }}</div>
    {% endfor %}

    <div class="user-stats">
        <div class="stat-box"><h4>{{ stats.total }}</h4><span>Total utilisateurs</span></div>
        <div class="stat-box"><h4>{{ stats.admins }}</h4><span>Administrateurs</span></div>
        <div class="stat-box"><h4>{{ stats.users }}</h4><span>Utilisateurs</span></div>
        <div class="stat-box"><h4>{{ stats.verified }}</h4><span>Emails vérifiés</span></div>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <h4>Répartition par rôle</h4>
            <div class="chart-wrap"><canvas id="chartRoles"></canvas></div>
        </div>
        <div class="chart-card">
            <h4>Statut de vérification</h4>
            <div class="chart-wrap"><canvas id="chartVerified"></canvas></div>
        </div>
    </div>

    <div class="toolbar">
        <div class="search-wrap">
            <i class="fa fa-search"></i>
            <input type="text" id="searchInput" placeholder="Rechercher par email, nom, téléphone..." value="{{ app.request.query.get('q', '') }}">
        </div>
        <div class="filter-wrap">
            <select id="roleFilter">
                <option value="">Tous les rôles</option>
                <option value="ROLE_USER" {{ app.request.query.get('role') == 'ROLE_USER' ? 'selected' : '' }}>Utilisateur</option>
                <option value="ROLE_ADMIN" {{ app.request.query.get('role') == 'ROLE_ADMIN' ? 'selected' : '' }}>Admin</option>
            </select>
        </div>
        <a href="{{ path('app_user_csv', {q: app.request.query.get('q'), role: app.request.query.get('role')}) }}" class="btn-export">
            <i class="fa fa-download"></i> Exporter CSV
        </a>
        <a href="{{ path('app_user_new') }}" class="btn-add"><i class="fa fa-plus"></i> Nouvel utilisateur</a>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Utilisateur</th>
                    <th>Email</th>
                    <th>Téléphone</th>
                    <th>Rôle</th>
                    <th>Vérifié</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                {% include 'BackOffice/user/_user_table.html.twig' with {users: users} %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx1 = document.getElementById('chartRoles');
    if (ctx1) {
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Utilisateurs', 'Administrateurs'],
                datasets: [{
                    data: [{{ stats.users }}, {{ stats.admins }}],
                    backgroundColor: ['#3b82f6', '#f59e0b'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }
    const ctx2 = document.getElementById('chartVerified');
    if (ctx2) {
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Vérifiés', 'Non vérifiés'],
                datasets: [{
                    data: [{{ stats.verified }}, {{ stats.total - stats.verified }}],
                    backgroundColor: ['#22c55e', '#ef4444'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    let debounce;
    function fetchUsers() {
        const q = document.getElementById('searchInput').value;
        const role = document.getElementById('roleFilter').value;
        fetch('{{ path('app_user_ajax') }}?q=' + encodeURIComponent(q) + '&role=' + encodeURIComponent(role))
            .then(r => r.text())
            .then(html => { document.getElementById('userTableBody').innerHTML = html; });
    }
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(debounce);
        debounce = setTimeout(fetchUsers, 300);
    });
    document.getElementById('roleFilter').addEventListener('change', fetchUsers);
});
</script>
{% endblock %}
