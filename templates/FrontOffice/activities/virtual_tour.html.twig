{% extends 'basefront.html.twig' %}

{% block title %}{{ activity.title }} - Visite Virtuelle 360¬∞{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
<style>
.virtual-tour-container {
    margin-top: 80px;
    padding: 40px 0;
}

#panorama {
    width: 100%;
    height: 600px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.tour-info {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-top: 30px;
}

.vr-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 50px;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.3s;
    margin-top: 20px;
}

.vr-button:hover {
    transform: scale(1.05);
}

.control-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.95);
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 100;
}

.control-panel button {
    margin: 5px;
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background: #4a7c2e;
    color: white;
}

.control-panel button:hover {
    background: #3a6b1e;
}

.hotspot {
    height: 30px;
    width: 30px;
    background: rgba(255, 255, 255, 0.8);
    border: 3px solid #4a7c2e;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s;
}

.hotspot:hover {
    background: #4a7c2e;
    transform: scale(1.2);
}

.info-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    border-left: 4px solid #4a7c2e;
}

.map-container {
    height: 400px;
    border-radius: 15px;
    overflow: hidden;
    margin-top: 30px;
}
</style>
{% endblock %}

{% block body %}
<div class="virtual-tour-container">
    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-12 text-center">
                <h1>üåç Visite Virtuelle 360¬∞</h1>
                <h2>{{ activity.title }}</h2>
                <p class="lead">{{ activity.location }}</p>
            </div>
        </div>

        <!-- 360¬∞ Panorama Viewer -->
        <div class="row">
            <div class="col-md-12">
                {% if activity.image360 %}
                    <div id="panorama"></div>
                    
                    <!-- VR Mode Button -->
                    <div class="text-center">
                        <button class="vr-button" id="vrButton">
                            <i class="fa fa-vr-cardboard"></i> Mode R√©alit√© Virtuelle
                        </button>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i> 
                        La visite virtuelle 360¬∞ n'est pas encore disponible pour cette activit√©.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Activity Info Cards -->
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="info-card">
                    <h4><i class="fa fa-clock-o"></i> Dur√©e</h4>
                    <p>{{ activity.durationMinutes }} minutes</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-card">
                    <h4><i class="fa fa-users"></i> Participants</h4>
                    <p>Max {{ activity.maxParticipants }} personnes</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-card">
                    <h4><i class="fa fa-tag"></i> Prix</h4>
                    <p>{{ activity.price }} TND / personne</p>
                </div>
            </div>
        </div>

        <!-- Interactive Map -->
        {% if activity.latitude and activity.longitude %}
        <div class="row">
            <div class="col-md-12">
                <div class="tour-info">
                    <h3><i class="fa fa-map-marker"></i> Localisation</h3>
                    <div id="map" class="map-container"></div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Description -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="tour-info">
                    <h3><i class="fa fa-info-circle"></i> √Ä propos de cette activit√©</h3>
                    <p>{{ activity.description }}</p>
                    
                    <div class="text-center mt-4">
                        <a href="{{ path('app_activity_show', {id: activity.id}) }}" class="btn btn-primary btn-lg">
                            <i class="fa fa-calendar-check-o"></i> R√©server cette activit√©
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<!-- Pannellum 360¬∞ Viewer -->
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<!-- Mapbox for Interactive Map -->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if activity.image360 %}
    // Initialize 360¬∞ Panorama Viewer
    const viewer = pannellum.viewer('panorama', {
        "type": "equirectangular",
        "panorama": "{{ asset('uploads/activities/360/' ~ activity.image360) }}",
        "autoLoad": true,
        "autoRotate": -2,
        "compass": true,
        "showControls": true,
        "showFullscreenCtrl": true,
        "showZoomCtrl": true,
        "mouseZoom": true,
        "hfov": 110,
        "pitch": 0,
        "yaw": 0,
        "hotSpots": [
            {
                "pitch": 10,
                "yaw": 30,
                "type": "info",
                "text": "Point de d√©part de l'activit√©",
                "cssClass": "hotspot"
            },
            {
                "pitch": -5,
                "yaw": 120,
                "type": "info",
                "text": "Zone de rassemblement",
                "cssClass": "hotspot"
            }
        ]
    });

    // VR Mode Button
    document.getElementById('vrButton').addEventListener('click', function() {
        if (viewer.isLoaded()) {
            viewer.toggleFullscreen();
        }
    });
    {% endif %}

    {% if activity.latitude and activity.longitude %}
    // Initialize Mapbox
    mapboxgl.accessToken = 'YOUR_MAPBOX_TOKEN'; // Replace with your token
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/outdoors-v12',
        center: [{{ activity.longitude }}, {{ activity.latitude }}],
        zoom: 14,
        pitch: 45,
        bearing: 0
    });

    // Add 3D Terrain
    map.on('load', function() {
        map.addSource('mapbox-dem', {
            'type': 'raster-dem',
            'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
            'tileSize': 512,
            'maxzoom': 14
        });
        
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

        // Add sky layer
        map.addLayer({
            'id': 'sky',
            'type': 'sky',
            'paint': {
                'sky-type': 'atmosphere',
                'sky-atmosphere-sun': [0.0, 90.0],
                'sky-atmosphere-sun-intensity': 15
            }
        });

        // Add marker
        new mapboxgl.Marker({ color: '#4a7c2e' })
            .setLngLat([{{ activity.longitude }}, {{ activity.latitude }}])
            .setPopup(new mapboxgl.Popup().setHTML('<h4>{{ activity.title }}</h4><p>{{ activity.location }}</p>'))
            .addTo(map);

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(new mapboxgl.FullscreenControl());
    });
    {% endif %}
});
</script>
{% endblock %}
